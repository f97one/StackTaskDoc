.. _task_editor_activity:

==============
タスク編集画面
==============

物理名、宣言
============

``class TaskEditorActivity : AbstractAppActivity()``


画面部品
========

.. list-table::
   :header-rows: 1

   * - 論理名
     - 種別
     - I/O
     - 最大桁数
     - 入力規則
     - 初期値
     - 導入元
     - 備考
   * - タイトル
     - TextView
     - O
     - -
     - -
     - Add Task
     - -
     - 編集の場合「Edit Task」
   * - タスク名
     - EditText
     - I/O
     - 32
     - -
     - -
     - タスクアイテム.タスク名
     - 追加時は空欄
   * - 期日
     - Button
     - I/O
     - -
     - -
     - -
     - タスクアイテム.期日
     - 追加時は現在日時の1週間後、端末の ``DateFormat`` を取得して整形
   * - 優先度
     - RatingBar
     - I/O
     - -
     - -
     - -
     - タスクアイテム.優先度
     - 追加時は1
   * - タスク詳細
     - EditText
     - I/O
     - 200
     - -
     - -
     - タスクアイテム.タスク詳細
     - 追加時は空欄
   * - タスク詳細文字数
     - TextView
     - O
     - -
     - -
     - -
     - タスクアイテム.タスク詳細 の文字数
     - 追加時は0固定
   * - 完了チェック
     - CheckBox
     - I/O
     - -
     - -
     - Done
     - タスクアイテム.完了チェック
     - 追加時は非表示( ``View.INVISIBLE`` )かつチェックオフ
   * - 登録ボタン
     - FloatingActionButton
     - I/O
     - -
     - -
     - -
     - -
     - 鉛筆マークを描画

イベント処理
============

初期化
------

#. | レイアウトXMLを展開後、Viewをinjectする。
   | ※ ``androidx`` で行う。
#. ``Intent`` から タスクアイテム オブジェクトを取得する。
#. タスクアイテム オブジェクトが取得できた場合は、以下を行う。

   #. タスクアイテムの各値を画面へ反映する。
   #. タイトルを「Edit Task」にする。
   #. 期日格納変数に、タスクアイテム.期日を代入する。

#. タスクアイテム オブジェクトが取得できなかった場合は、以下を行う。

   #. 画面部品の記述にしたがい画面を初期化する。
   #. 期日格納変数に、現在日時の1週間後を代入する。

タスク詳細入力時
----------------

#. 画面部品.タスク詳細への文字の追加削除が発生するたびに、発生後の文字数を取得する。
#. 文字数を画面部品.タスク詳細文字数に反映する。
#. 反映後、文字数が181以上の場合は文字色を赤に、180以下の場合は文字色を黒にする。

期日クリック時
--------------

#. 期日格納変数の値を引数として、 :ref:`date_time_picker_dialog` にある日時入力ダイアログを初期化する。
#. 日時入力ダイアログにコールバックリスナをセットする。
#. 日時入力ダイアログがキャンセルされず、コールバックリスナから値が返ってきた場合、期日格納変数の時分を日時入力ダイアログの値に置き換える。
#. 期日格納変数の値を端末の `DateFormat` でフォーマットし、期日ボタンに表示する。

タスク登録ボタンクリック時
--------------------------

#. 画面部品.タスク名の入力値を取得し、文字数が33文字以上の場合は「Task name must be 32 characters or less.」をダイアログ表示し、以後の処理を終了する。
#. 画面部品.タスク詳細の入力値を取得し、文字数が201文字以上の場合は「Details must be 200 characters or less.」をダイアログ表示し、以後の処理を終了する。
#. 画面部品.完了チェックがオンの時、以下を行う。

   #. ``SharedPreference`` から「タスクを終了させるときに確認ダイアログを出すかどうか」の設定を取得する。
   #. 設定値が ``true`` または設定なしの場合、「This task is completed. Is it OK?(このタスクは完了されます。よろしいですか？)」と確認ダイアログを表示する。

      #. 確認ダイアログで「Yes」を選択したとき、 :ref:`on_task_item_updated` を実施する。
      #. 確認ダイアログで「No」を選択したとき、または確認ダイアログをキャンセルしたときは、何も行わない。

   #. 設定値が ``false`` の場合、 :ref:`on_task_item_updated` を実施する。

.. _on_task_item_updated:

タスクアイテム反映処理
----------------------

#. 各画面部品の入力値から、タスクアイテムを作成する。

   +------------+----------------------------------------------------------------+
   | プロパティ | 導入元                                                         |
   +============+================================================================+
   | taskId     | ``FirebaseDatabase#getKey()`` の値                             |
   +------------+----------------------------------------------------------------+
   | taskName   | 画面部品.タスク名                                              |
   +------------+----------------------------------------------------------------+
   | dueDate    | 期日格納変数の値を ``yyyy/MM/dd HH:mm`` でフォーマットしたもの |
   +------------+----------------------------------------------------------------+
   | priority   | 画面部品.優先度の値                                            |
   +------------+----------------------------------------------------------------+
   | taskDetail | 画面部品.タスク詳細                                            |
   +------------+----------------------------------------------------------------+
   | finished   | 画面部品.完了チェックの値                                      |
   +------------+----------------------------------------------------------------+
   | createdAt  | 作成時のみ現在日時、それ以外は操作しない                       |
   +------------+----------------------------------------------------------------+
   | updatedAt  | 現在日時                                                       |
   +------------+----------------------------------------------------------------+

#. Firebase Realtime Database へ反映する。
#. 反映終了後、作成時は「Task created.」、更新時は「Task modified.」を、それぞれ ``Toast`` 表示する。
#. :ref:`task_list_activity` へ遷移する。

.. _date_time_picker_dialog:

日時入力ダイアログの処理
------------------------

インスタンス作成時
^^^^^^^^^^^^^^^^^^

#. ``Calendar`` のオブジェクトを受け取り、 ``Bundle`` に格納する。

コールバックリスナ設定
^^^^^^^^^^^^^^^^^^^^^^

#. コールバックリスナのオブジェクトを受け取る。

``onCreateDialog`` の処理
^^^^^^^^^^^^^^^^^^^^^^^^^

#. ``Bundle`` からインスタンス作成時に取得した ``Calendar`` のオブジェクトから、年、月、日、時(24時制)、分をそれぞれ取り出す。
#. 同じく、``Calendar`` のオブジェクトの ``timeInMillis`` プロパティを取り出し、戻り値とする新たな ``Calendar`` オブジェクトにセットする。
#. 画面表示に使う ``AlertDialog`` を初期化する。
#. 取り出した年、月、日で、  ``AlertDialog`` 上の ``DatePicker`` を初期化する。
#. ``DatePicker`` の表示を ``View.VISIBLE`` とする。
#. 同じく、取り出した時(24時制)、分で、 ``AlertDialog`` 上の  ``TimePicker`` を初期化する。
#. ``TimePicker`` の表示を ``View.GONE`` とする。
#. ``PositiveButton`` に「Determine(決定)」をラベル設定し、表示する。
#. ``AlertDialog`` を作成する。

日付決定時
^^^^^^^^^^

#. 戻り値の ``Calendar`` オブジェクトに、入力値の年、月、日を設定する。
#. ``DatePicker`` の表示を ``View.GONE`` とする。
#. ``TimePicker`` の表示を ``View.VISIBLE`` とする。

時刻決定時
^^^^^^^^^^

#. 戻り値の ``Calendar`` オブジェクトに、入力値の時(24時制)、分を設定する。

``PositiveButton`` 押下時
^^^^^^^^^^^^^^^^^^^^^^^^^

#. コールバックリスナを通じ、戻り値の ``Calendar`` オブジェクトを呼び出し元へ返す。